<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-xhr/core-xhr.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">

<link rel="import" href="maitai-query-builder.html">
<link rel="import" href="maitai-query-service.html">

<polymer-element name="maitai-field" attributes="url query chartType">

  <template>
    <!-- http://japhr.blogspot.com/2014/06/dynamically-adding-external-styles-to.html -->
    <link type="text/css" rel="stylesheet" href="css/metricsgraphics.css">
    <link type="text/css" rel="stylesheet" href="css/metricsgraphics-dark.css">
    <style>
    :host {
      display: block;
      position: relative;
      padding: 20px;
      width: 100%;
      font-size: 1.2rem;
      font-weight: 300;
      border: 1px solid #fc0;
      border-radius: 10px;
    }
    .card-header {
      margin-bottom: 10px;
    }
    polyfill-next-selector { content: '.card-header h1'; }
    .card-header ::content h1 {
        display: block;
        margin: 0;
        font-size: 1.8rem;
        font-weight: 300;
    }
    .card-header textarea {
        height: 30px;
        width: 80%;
    }
    .card-header span {
        display: block;
        font-size: 0.8rem;
        font-weight: 100;
    }
    #error {
      font-weight: 900;
      color: #d33;
    }
    #debug {
      display: none;
    }
    #debug.on {
      display: block;
    }
    #debug span {
      font-family: monospace;
      font-size: 10px;
      color: #ddd;
    }
    </style>
    <div class="card-header">
        <content></content>
        <div id="error">{{error.message}}</div>

        <div id="graphicTarget"></div>
        <div horizontal end-justified layout>
          <core-icon on-click="{{toggleDebugDisplay}}" icon="visibility"></core-icon>
        </div>
        <div id="debug">
          <span>{{iql}}</span>
        </div>
        <maitai-query-builder id="builder" query="{{query}}"></maitai-query-builder>
    </div>
    <content></content>
    <maitai-query-service id="queryService" iql="{{iql}}" query="{{query}}" response="{{responseData}}"></maitai-query-service>
  </template>
  <script>
      Polymer({
        ready: function() {
          var self = this
          self.query = self.query || {}

          self.$.builder.addEventListener('query-changed', function() {
            console.debug('maitai-field: query-changed!')
            self.$.queryService.compileQuery()
          })
          self.$.queryService.addEventListener('error', function(e) {
            console.error(e.detail.message)  // TODO dialog?
            self.error = e.detail
          })
        },
        toggleDebugDisplay: function(e, detail, sender) {
          this.$.debug.classList.toggle('on')
        },
        observe: {
          'responseData': 'chartDataLoaded'
        },
        chartDataLoaded: function(oldData, data) {
          var self = this
          if (this.query.type == 'histogram') {
            data_graphic({
                data: data.points,
                target: self.$.graphicTarget,
                chart_type: 'histogram',
                binned: true,
                width: 750,
                y_extended_ticks: true,
                x_accessor:'value',
                y_accessor:'count',
                markers: data.baselines
            })
          }
          else {
            data_graphic({
                data: data.points,
                target: self.$.graphicTarget,
                area: true,
                width: 750,
                height: 500,
                x_accessor:'time',
                y_accessor:'val',
                x_label: 'time',
                y_label: 'ms',
                show_confidence_band: ['lower', 'upper'],
                baselines: data.baselines
            })
          }
        },
        setFavorite: function(uid, isFavorite) {
          console.log('Favorite changed: ' + uid + ", now: " + isFavorite);
        }
      })
  </script>
</polymer-element>
