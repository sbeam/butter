<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-xhr/core-xhr.html">

<polymer-element name="magoo-field" attributes="url query chartType">

  <template>
    <!-- http://japhr.blogspot.com/2014/06/dynamically-adding-external-styles-to.html -->
    <link type="text/css" rel="stylesheet" href="css/metricsgraphics.css">
    <link type="text/css" rel="stylesheet" href="css/metricsgraphics-dark.css">
    <style>
    :host {
      display: block;
      position: relative;
      padding: 20px;
      width: 100%;
      font-size: 1.2rem;
      font-weight: 300;
      border: 1px solid #fc0;
      border-radius: 10px;
    }
    .card-header {
      margin-bottom: 10px;
    }
    polyfill-next-selector { content: '.card-header h1'; }
    .card-header ::content h1 {
        display: block;
        margin: 0;
        font-size: 1.8rem;
        font-weight: 300;
    }
    .card-header textarea {
        height: 30px;
        width: 80%;
    }
    .card-header span {
        display: block;
        font-size: 0.8rem;
        font-weight: 100;
    }

    </style>
    <div class="card-header">
        <content select="h1"></content>
        <div id="graphicTarget"></div>
        <textarea value="{{points_debug}}"></textarea>
        <span>{{iql}}</span>
        <span>{{chartType}}</span>
    </div>
    <content></content>
    <core-ajax id="influx" url="{{url}}" params='{"q":"{{iql}}", "u":"root","p":"password"}' handleAs="json" auto on-core-response="{{dataLoaded}}"></core-ajax>
    <core-xhr id="xhr"></core-xhr>
  </template>
  <script>
      Polymer({
        attached: function() {
          if (this.query.type == 'histogram') {
            this.iql = "select histogram(value, "+this.query.bucket_width+") from "+this.query.series.join(", ")+" where time > "+this.query.time_end+" - "+this.query.time_start+" and value < "+this.query.cutoff
          }
          else {
            this.base_iql = "select #function# from "+this.query.series.join(",")+" #group# where time > "+this.query.time_end+" - "+this.query.time_start+" and value < "+this.query.cutoff
            this.iql = this.base_iql.replace(/#function#/, 'median(value), percentile(value, 60), percentile(value, 40)').replace(/#group#/, "group by time("+this.query.time_group+")") //, percentile(value, 95)
          }
        },
        dataLoaded: function() {
          var self = this
          if (self.chartType == 'histogram') {
            self.points = self.$.influx.response[0].points
            self.buckets = _.map(self.points, function(v, i) { return { count: v[2], value: v[1] } })
            self.buckets = _.sortBy(self.buckets, function(a) { return a.value } )
            self.points_debug = _.map(self.buckets, function(b) { return ""+b.value+"=>"+b.count }).join("\n")

            var histo = data_graphic({
                data: self.buckets,
                target: self.$.graphicTarget,
                chart_type: self.chartType,
                binned: true,
                width: 750,
                y_extended_ticks: true,
                x_accessor:'value',
                y_accessor:'count'
            })
          }
          else {
            //self.lineData = _.map(self.$.influx.response, function(metric) {
            self.lineData = _.map(self.$.influx.response, function(metric) {
              var points = _.map(metric.points, function(point) {
                return { time: point[0]/1000, val: point[1], upper: point[2], lower: point[3] }
              })
              return _.sortBy(points, function(a) { return a.time } )
            })
            self.points_debug = JSON.stringify(self.lineData)
            console.log(JSON.stringify(self.lineData))

            var params = JSON.parse(self.$.influx.params)
            params.q = self.base_iql.replace(/#function#/, "median(value)").replace(/#group#/, "")

            self.$.xhr.request({url: self.$.influx.url, params: params, callback: function(baselineData) {
              var baselines = _.map(JSON.parse(baselineData), function(line) {
                var val = line.points[0][1]
                return { value: val, label: 'median:'+val }
              })
              data_graphic({
                  data: self.lineData,
                  target: self.$.graphicTarget,
                  area: true,
                  width: 750,
                  height: 500,
                  x_accessor:'time',
                  y_accessor:'val',
                  x_label: 'time',
                  y_label: 'ms',
                  show_confidence_band: ['lower', 'upper'],
                  baselines: baselines
              })

            }})

          }
        },
        setFavorite: function(uid, isFavorite) {
          console.log('Favorite changed: ' + uid + ", now: " + isFavorite);
        }
      })
  </script>
</polymer-element>
